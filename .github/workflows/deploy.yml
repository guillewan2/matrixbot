name: Deploy to VPS

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: production-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}        
          username: ${{ secrets.VPS_USER }}    
          key: ${{ secrets.SSH_PRIVATE_KEY }}  
          port: ${{ secrets.VPS_PORT }}
          timeout: 120s
          command_timeout: 15m
          script: |
            set -e  # Exit immediately if a command exits with a non-zero status
            
            PROJECT_DIR="/admin/matrixbot"
            BACKUP_DIR="/admin/backups/matrixbot"
            DATE=$(date +%Y%m%d_%H%M%S)
            
            echo "üöÄ Starting deployment..."
            
            # 1. Verification
            if [ ! -d "$PROJECT_DIR" ]; then
                echo "‚ùå Project directory not found at $PROJECT_DIR"
                exit 1
            fi
            
            cd "$PROJECT_DIR"
            
            if [ ! -f ".env" ]; then
                echo "‚ùå CRITICAL: .env file missing!"
                exit 1
            fi
            
            # 2. Backup E2EE Store
            echo "üì¶ Backing up session store..."
            mkdir -p "$BACKUP_DIR"
            if [ -d "store" ]; then
                tar -czf "$BACKUP_DIR/store_$DATE.tar.gz" store/
                # Keep only last 5 backups
                ls -dt "$BACKUP_DIR"/store_*.tar.gz | tail -n +6 | xargs -r rm
                echo "‚úÖ Backup created at $BACKUP_DIR/store_$DATE.tar.gz"
            else
                echo "‚ö†Ô∏è No store directory found, skipping backup."
            fi
            
            # 3. Update Code
            echo "üì• Pulling latest changes from GitHub..."
            git fetch --all
            git reset --hard origin/main
            
            # 4. Rebuild
            echo "üê≥ Rebuilding containers..."
            # Stop first to ensure clean state
            docker compose down || true
            
            # Build and Start
            if ! docker compose up -d --build --remove-orphans; then
                echo "‚ùå Docker build/start failed!"
                # Restore backup if needed? (Advanced: could restore previous image here)
                exit 1
            fi
            
            # 5. Cleanup
            echo "üßπ Cleaning up unused Docker images..."
            docker image prune -f
            
            # 6. Health Check Loop
            echo "‚è≥ Waiting for service to become healthy (max 60s)..."
            MAX_RETRIES=12
            RETRY=0
            HEALTHY=0
            
            while [ $RETRY -lt $MAX_RETRIES ]; do
                if curl -sf --max-time 2 http://localhost:23983/webhook/health > /dev/null; then
                    echo "‚úÖ Health check passed!"
                    HEALTHY=1
                    break
                fi
                echo "Testing connection... ($RETRY/$MAX_RETRIES)"
                sleep 5
                RETRY=$((RETRY+1))
            done
            
            if [ $HEALTHY -eq 0 ]; then
                echo "‚ùå Health check FAILED after 60 seconds."
                echo "üìú Recent logs:"
                docker compose logs --tail=50 matrixbot
                exit 1
            fi
            
            echo "‚úÖ Deploy completed successfully!"